<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>Bubble Input Text Field</title>
	<script type="text/javascript" src="libs/external/knockout-2.0.0.js"></script>
	<link href="css/reset.less" rel="stylesheet" type="text/less">
	<link href="css/body.less" rel="stylesheet" type="text/less">
	<script type="text/javascript" src="libs/external/less-1.3.0.js"></script>
	<script type="text/javascript" src="libs/external/jquery-1.7.2.js"></script>
	<script type="text/javascript" src="libs/external/knockout-2.0.0.js"></script>
	<script type="text/javascript" src="libs/external/google-fastbutton-2012-10-02.js"></script>
	<script type="text/javascript" src="libs/external/closure-library-base-2012-01-19.js"></script>
	<script type="text/javascript" src="libs/internal/Base.js"></script> <!-- Base.js must be included statically -->
	<script type="text/javascript" src="libs/internal/util/Utils.js"></script>
	<script type="text/javascript" src="js/ctrl/bubbleinput/BubbleInputViewModel.js"></script>
	<script type="text/javascript" src="js/ctrl/bubbleinput/BubbleHandler.js"></script>
	<script type="text/javascript" src="js/ctrl/bubbleinput/Bubble.js"></script>
	<script type="text/javascript" src="js/ctrl/bubbleinput/Suggestion.js"></script>
	<script type="text/javascript" src="js/gui/BubbleInputGui.js"></script>
	<style type="text/css">
		body {
			background: white;
		}
		
		div#mailInput {
			position: relative;
			top: 50px;
			left: 100px;
			width: 500px;
		}
		div#searchInput {
			position: relative;
			top: 100px;
			left: 100px;
			width: 500px;
		}
		
		div#widthTest {
			position: relative;
			top: 150px;
			left: 100px;
			width: 500px;
		}
		
		div#log {
			position: relative;
			top: 200px;
			left: 100px;
			width: 500px;
		}
		
		span.bubble.default {
			background: #DDE2E9;
		}
		
		span.bubble.suggestion {
			background: #FFCCCC;
		}
	</style>
</head>
<body>
	
	<h1>Bubble Input</h1>
	<script type="text/javascript">
		ko.bindingHandlers['class'] = {
		    'update': function(element, valueAccessor) {
		        if (element['__ko__previousClassValue__']) {
		            ko.utils.toggleDomNodeCssClass(element, element['__ko__previousClassValue__'], false);
		        }
		        var value = ko.utils.unwrapObservable(valueAccessor());
		        ko.utils.toggleDomNodeCssClass(element, value, true);
		        element['__ko__previousClassValue__'] = value;
		    }
		};
		ko.bindingHandlers.click = {
			init: function(element, valueAccessor, allBindingsAccessor, viewModel) {
				new FastButton(element, function(event) {
					valueAccessor()(viewModel, event);
				});
			}
		};
		
		/**
		 * @implements {tutao.tutanota.ctrl.bubbleinput.BubbleHandler}
		 */
		tutao.tutanota.ctrl.bubbleinput.MailBubbleHandler = function() {
			 tutao.util.Utils.bindPrototypeMethodsToThis(this);
		};
		tutao.tutanota.ctrl.bubbleinput.MailBubbleHandler.prototype.getSuggestions = function(text) {
			var s = [new tutao.tutanota.ctrl.bubbleinput.Suggestion(1, 'Arne Möhle'), 
			        new tutao.tutanota.ctrl.bubbleinput.Suggestion(2, 'Thomas Gutsche'),
			        new tutao.tutanota.ctrl.bubbleinput.Suggestion(3, 'Matthias Pfau')];
			if (text == "") {
				return s;
			}
			var sugs = [];
			for (var i=0; i<s.length; i++) {
				if (s[i].text.indexOf(text) != -1) {
					sugs.push(s[i]);
				}
			}
			return sugs;
		};
		
		tutao.tutanota.ctrl.bubbleinput.MailBubbleHandler.prototype.createBubbleFromText = function(value) {
			var nameWithMail = /^([^<]+)<\s*([^\s@]+@[^\s@]+\.[^\s@>]+)\s*>$/; // matches an address like "Arne<arne@tutao.de>
			var mail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // matches pure mail addresses like tommy@tutao.de
			if (mail.test(value)) {
				return new tutao.tutanota.ctrl.bubbleinput.Bubble(null, ko.observable(value), ko.observable("tooltip"), ko.observable('default'));
			} else {
				var matches = value.match(nameWithMail);
				if (matches && matches.length === 3) {
					return new tutao.tutanota.ctrl.bubbleinput.Bubble(null, ko.observable(matches[1].trim() + ": " + matches[2].trim()), ko.observable("tooltip"), ko.observable('default'));
				}
			}
			return null;
		};
		
		tutao.tutanota.ctrl.bubbleinput.MailBubbleHandler.prototype.createBubbleFromSuggestion = function(suggestion) {
			return new tutao.tutanota.ctrl.bubbleinput.Bubble(null, ko.observable(suggestion.text), ko.observable("tooltip"), ko.observable('suggestion'));
		};
		
		tutao.tutanota.ctrl.bubbleinput.MailBubbleHandler.prototype.buttonClick = function() {};

		tutao.tutanota.ctrl.bubbleinput.MailBubbleHandler.prototype.buttonSrc = function() {};
		
		
		tutao.tutanota.ctrl.bubbleinput.TextBubbleHandler = function() {
			 tutao.util.Utils.bindPrototypeMethodsToThis(this);
		};
		tutao.tutanota.ctrl.bubbleinput.TextBubbleHandler.prototype.getSuggestions = function(text) {
			return [];
		};
		
		tutao.tutanota.ctrl.bubbleinput.TextBubbleHandler.prototype.createBubbleFromText = function(value) {
			return new tutao.tutanota.ctrl.bubbleinput.Bubble(null, ko.observable(value), ko.observable("tooltip"), ko.observable('default'));
		};
		
		tutao.tutanota.ctrl.bubbleinput.TextBubbleHandler.prototype.createBubbleFromSuggestion = function(suggestion) {
			throw Error("§");
		};
		
		tutao.tutanota.ctrl.bubbleinput.TextBubbleHandler.prototype.buttonClick = function() {
			this.viewModel.bubbles.removeAll();
			this.viewModel.inputValue("");
		};

		tutao.tutanota.ctrl.bubbleinput.TextBubbleHandler.prototype.buttonSrc = function(){};
	
		var mailBubbleHandler = new tutao.tutanota.ctrl.bubbleinput.MailBubbleHandler();
		mailBubbleHandler.buttonSrc = function() {};
		var bubbleInputViewModelMail = new tutao.tutanota.ctrl.bubbleinput.BubbleInputViewModel(mailBubbleHandler);

		var textBubbleHandler = new tutao.tutanota.ctrl.bubbleinput.TextBubbleHandler();
		var bubbleInputViewModelSearch = new tutao.tutanota.ctrl.bubbleinput.BubbleInputViewModel(textBubbleHandler);
		
		textBubbleHandler.viewModel = bubbleInputViewModelSearch;
		textBubbleHandler.buttonSrc = ko.computed(function(){
			if(this.viewModel.inputValue().trim() || this.viewModel.bubbles().length > 0) {
				return 'graphics/cancel.png';
			} else {
				return 'graphics/search.png';
			}
		},textBubbleHandler);
		
		$(document).ready(function() {
			ko.applyBindings({});
		});
		
		function touchHandler(event)
		{
		 var touches = event.changedTouches,
		    first = touches[0],
		    type = "";

		     switch(event.type)
		{
		    case "touchstart": type = "mousedown"; break;
		    case "touchmove":  type="mousemove"; break;        
		    case "touchend":   type="mouseup"; break;
		    default: return;
		}
		var simulatedEvent = document.createEvent("MouseEvent");
		simulatedEvent.initMouseEvent(type, true, true, window, 1,
		                          first.screenX, first.screenY,
		                          first.clientX, first.clientY, false,
		                          false, false, false, 0/*left*/, null);

		first.target.dispatchEvent(simulatedEvent);
		event.preventDefault();
		}

		function init()
		{
		   document.addEventListener("touchstart", touchHandler, true);
		   document.addEventListener("touchmove", touchHandler, true);
		   document.addEventListener("touchend", touchHandler, true);
		   document.addEventListener("touchcancel", touchHandler, true);    
		}
		//init();
	</script>
	<div id="mailInput">Mail: 
		<div data-bind='template: { name: "bubbleinput-template",  data: bubbleInputViewModelMail }'></div>
	</div>
	
	<div id="searchInput">Search: 
		<div data-bind='template: { name: "bubbleinput-template",  data: bubbleInputViewModelSearch }'></div>
	</div>
	
	<div id="log"></div>

	<!-- use only with the BubbleInputViewModel -->
	<script type="text/html"  id="bubbleinput-template">
		<div class="bubbleInput">
			<div class="input" tabindex="-1" data-bind="css: {focus: active}, click: setInputActive">
				<div class="inputContainer">
					<!-- ko foreach: bubbles -->
						<span class="bubble" data-bind="text: text, css: {selected: selected}, class: state, click: invertSelection"></span>
					<!-- /ko -->
					<!-- prevent the click event on the input from bubbling to the inputWrapper as this would reset the selection -->
					<div><input type="text" data-bind="value: inputValue, valueUpdate: 'keyup', hasfocus: inputActive, click: function() {}, clickBubble: false, event: {keyup: handleKey, focus: inputFieldFocusFired, blur: inputFieldBlurFired}" autocorrect="off" autocapitalize="none" autocomplete="off" spellcheck="false"></input></div>
				</div>
				<!-- ko if: bubbleHandler.buttonSrc() -->
					<div class="buttonContainer" data-bind="click: bubbleHandler.buttonClick">
						<img data-bind="attr: {src: bubbleHandler.buttonSrc}"/>
					</div>
				<!-- /ko -->
			</div>
			<div class="autocompletebox" data-bind="foreach: suggestions, css: {hidden: suggestions().length === 0 || !active()}">
				<!-- css: {selected: selected}, -->
				<div class="autocompleteEntry" data-bind="text: text, click: $parent.acceptSuggestion, event: {mousedown: $parent.suggestionMousedownFired}"></div>
			</div>
		</div>
	</script>

</body>